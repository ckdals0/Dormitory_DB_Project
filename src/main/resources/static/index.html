<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ìˆ™ì‚¬ í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }

        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; text-align: center; margin-bottom: 30px; }
        .back-link { display: block; margin-bottom: 20px; color: #7f8c8d; text-decoration: none; font-weight: bold; }

        .container { display: flex; gap: 30px; flex-wrap: wrap; }
        .form-box, .list-box { flex: 1; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-width: 320px; }

        h3 { margin-top: 0; color: #34495e; display: flex; align-items: center; gap: 8px; justify-content: space-between; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #555; }

        input, select { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: 0.3s; }
        button { width: 100%; margin-top: 25px; padding: 12px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.3s; }
        button:hover { background-color: #2980b9; }

        /* ê²€ìƒ‰ì°½ */
        .search-container { display: flex; gap: 8px; margin-bottom: 15px; }
        .search-input { flex: 1; margin-top: 0; padding: 10px; }
        .search-btn { width: auto; margin-top: 0; padding: 10px 20px; background-color: #2c3e50; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-wrapper { max-height: 500px; overflow-y: auto; margin-top: 10px; border: 1px solid #eee; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 10px; text-align: left; }

        /* â˜… ì •ë ¬ ê°€ëŠ¥í•œ í—¤ë” ìŠ¤íƒ€ì¼ */
        th { background-color: #f8f9fa; color: #444; font-weight: 600; position: sticky; top: 0; z-index: 1; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #e9ecef; }
        .sort-icon { display: inline-block; margin-left: 5px; font-size: 12px; color: #999; }
        .sort-asc .sort-icon::after { content: "â–²"; color: #3498db; }
        .sort-desc .sort-icon::after { content: "â–¼"; color: #e74c3c; }

        tr.selected { background-color: #e3f2fd; border-left: 4px solid #3498db; }
        tr:hover { background-color: #f1f5f9; cursor: pointer; }

        .manage-actions { display: none; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; align-items: center; }
        .btn-move { background-color: #1abc9c; width: auto; margin-top: 0; padding: 10px 15px; font-size: 14px; }
        .btn-exit { background-color: #7f8c8d; width: auto; margin-top: 0; padding: 10px 15px; font-size: 14px; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; width: 400px; border-radius: 10px; }
    </style>
</head>
<body>

<div style="max-width: 1000px; margin: 0 auto;">
    <a href="/manager_main.html" class="back-link">â¬… ê´€ë¦¬ì ë©”ì¸ìœ¼ë¡œ</a>
</div>

<h1>ğŸ í•™ìƒ ê´€ë¦¬</h1>

<div class="container">
    <div class="form-box">
        <h3>ğŸ“ í•™ìƒ ë“±ë¡</h3>
        <label>í•™ë²ˆ (SID)</label><input type="text" id="sid" placeholder="ì˜ˆ: 2024002">
        <label>ì´ë¦„</label><input type="text" id="name" placeholder="ì˜ˆ: í™ê¸¸ë™">
        <label>ì„±ë³„</label><select id="gender"><option value="M">ë‚¨ì„± (M)</option><option value="F">ì—¬ì„± (F)</option></select>
        <label>í•™ê³¼</label><select id="deptName"><option value="">í•™ê³¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option></select>
        <label>í˜¸ì‹¤</label><select id="roomNo"><option value="">ì…ì‹¤ ê°€ëŠ¥í•œ ë°© ì„ íƒ</option></select>
        <button onclick="registerStudent()">ë“±ë¡í•˜ê¸°</button>
    </div>

    <div class="list-box">
        <h3>ğŸ“‹ í•™ìƒ ëª©ë¡</h3>
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="ì´ë¦„ ë˜ëŠ” í•™ë²ˆ ê²€ìƒ‰" onkeyup="if(event.key==='Enter') loadStudents()">
            <button onclick="loadStudents()" class="search-btn">ğŸ” ê²€ìƒ‰</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>í•™ë²ˆ</th>
                    <th>ì´ë¦„</th>
                    <th>ì„±ë³„</th>
                    <th class="sortable" onclick="sortTable('deptName')">í•™ê³¼ <span id="icon-deptName" class="sort-icon">â†•</span></th>
                    <th class="sortable" onclick="sortTable('roomNo')">í˜¸ì‹¤ <span id="icon-roomNo" class="sort-icon">â†•</span></th>
                </tr>
                </thead>
                <tbody id="studentTableBody"></tbody>
            </table>
        </div>

        <div id="manageActions" class="manage-actions">
            <span id="selectedInfo" style="font-size:14px; font-weight:bold; color:#2c3e50; align-self:center;"></span>
            <div style="margin-left:auto; display:flex; gap:5px;">
                <button class="btn-move" onclick="openMoveModal()">ğŸ”„ í˜¸ì‹¤ ì´ë™</button>
                <button class="btn-exit" onclick="exitStudent()">ğŸšª í‡´ì†Œ ì²˜ë¦¬</button>
            </div>
        </div>
    </div>
</div>

<div id="moveModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ”„ í˜¸ì‹¤ ì´ë™</h3>
        <p id="moveTargetText" style="color:#666; font-size:14px;"></p>
        <label>ì´ë™í•  í˜¸ì‹¤ ì„ íƒ (ì…ì‹¤ ê°€ëŠ¥)</label>
        <select id="newRoomSelect" style="margin-bottom:20px;"></select>
        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button onclick="confirmMove()" class="btn-move" style="width:auto; margin-top:0;">ì´ë™</button>
            <button onclick="closeModal('moveModal')" style="width:auto; background:#95a5a6; margin-top:0; border:none; color:white; padding: 12px;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    let allStudents = [];
    let selectedStudent = null;
    let currentSort = { key: null, order: 'asc' };

    window.onload = function() {
        loadDepartments();
        loadAvailableRooms();
        loadStudents();
    };

    async function loadStudents() {
        const keyword = document.getElementById('searchInput').value;
        let url = keyword ? '/students?keyword=' + encodeURIComponent(keyword) : '/students';

        try {
            const response = await fetch(url);
            allStudents = await response.json();

            if (currentSort.key) {
                applySort();
            }
            renderTable();
        } catch (error) { console.error("Error:", error); }
    }

    function renderTable() {
        const tbody = document.getElementById("studentTableBody");
        tbody.innerHTML = "";
        selectedStudent = null;
        document.getElementById('manageActions').style.display = 'none';

        if (allStudents.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding: 20px;'>í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
            return;
        }

        allStudents.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${student.sid}</td><td>${student.name}</td><td>${student.gender}</td><td>${student.deptName}</td><td>${student.roomNo}</td>`;

            row.onclick = () => {
                document.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                row.classList.add('selected');
                selectedStudent = student;
                document.getElementById('manageActions').style.display = 'flex';
                document.getElementById('selectedInfo').innerText = `${student.name} (${student.sid}) | í˜„ì¬: ${student.roomNo}í˜¸`;
            };
            tbody.appendChild(row);
        });

        updateSortIcons();
    }

    function sortTable(key) {
        if (currentSort.key === key) {
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.key = key;
            currentSort.order = 'asc';
        }
        applySort();
        renderTable();
    }

    function applySort() {
        const key = currentSort.key;
        const order = currentSort.order;

        allStudents.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];

            if (!isNaN(valA) && !isNaN(valB)) {
                valA = Number(valA);
                valB = Number(valB);
            } else {
                valA = valA.toString().toLowerCase();
                valB = valB.toString().toLowerCase();
            }

            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });
    }

    function updateSortIcons() {
        document.getElementById('icon-deptName').innerText = 'â†•';
        document.getElementById('icon-roomNo').innerText = 'â†•';
        document.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));

        if (currentSort.key) {
            const iconId = 'icon-' + currentSort.key;
            const iconEl = document.getElementById(iconId);
            if (iconEl) {
                iconEl.innerText = currentSort.order === 'asc' ? 'â–²' : 'â–¼';
                iconEl.parentElement.classList.add(currentSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }
    }

    async function loadDepartments() { try { const r=await fetch('/api/departments'); const d=await r.json(); const s=document.getElementById('deptName'); d.forEach(dept=>{const o=document.createElement('option');o.value=dept;o.textContent=dept;s.appendChild(o);}); } catch(e){} }
    async function loadAvailableRooms() { try { const r=await fetch('/api/rooms/available'); const d=await r.json(); const s=document.getElementById('roomNo'); s.innerHTML='<option value="">ì…ì‹¤ ê°€ëŠ¥í•œ ë°© ì„ íƒ</option>'; d.forEach(room=>{const o=document.createElement('option');o.value=room;o.textContent=room+"í˜¸";s.appendChild(o);}); } catch(e){} }
    async function registerStudent() {
        const data = { sid: document.getElementById("sid").value, name: document.getElementById("name").value, gender: document.getElementById("gender").value, deptName: document.getElementById("deptName").value, roomNo: document.getElementById("roomNo").value };
        if(!data.sid || !data.name || !data.deptName || !data.roomNo) return alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”");
        try { const res = await fetch('/students', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            if(res.ok) { alert("ë“±ë¡ ì„±ê³µ"); loadStudents(); loadAvailableRooms(); document.getElementById("sid").value=""; document.getElementById("name").value=""; document.getElementById("deptName").value=""; document.getElementById("roomNo").value=""; } else alert("ë“±ë¡ ì‹¤íŒ¨");
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }
    async function openMoveModal() {
        if(!selectedStudent) return;
        try { const res = await fetch('/api/rooms/available'); const rooms = await res.json(); const select = document.getElementById('newRoomSelect'); select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>'; rooms.forEach(r => { if(r !== selectedStudent.roomNo) select.innerHTML += `<option value="${r}">${r}í˜¸</option>`; }); } catch(e){}
        document.getElementById('moveTargetText').innerText = `${selectedStudent.name} í•™ìƒ (${selectedStudent.roomNo}í˜¸)ì„ ì´ë™ì‹œí‚µë‹ˆë‹¤.`;
        document.getElementById('moveModal').style.display = 'flex';
    }
    async function confirmMove() {
        const newRoom = document.getElementById('newRoomSelect').value;
        if(!newRoom) return alert("ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        await fetch('/api/manager/student/move', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sid: selectedStudent.sid, newRoom: newRoom }) });
        alert("ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤."); closeModal('moveModal'); loadStudents(); loadAvailableRooms();
    }
    async function exitStudent() {
        if(!selectedStudent) return;
        if(!confirm(`${selectedStudent.name} í•™ìƒì„ í‡´ì†Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        await fetch('/api/manager/student/exit', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sid: selectedStudent.sid }) });
        alert("í‡´ì†Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."); loadStudents(); loadAvailableRooms();
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>