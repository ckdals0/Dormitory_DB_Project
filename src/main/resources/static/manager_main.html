<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì ì‹œìŠ¤í…œ - ê¸°ìˆ™ì‚¬</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        header { background-color: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .logout-btn { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .logout-btn:hover { background-color: #c0392b; }
        .container { max-width: 1200px; margin: 30px auto; padding: 20px; }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; color: #3498db; margin: 10px 0; }
        .stat-label { color: #7f8c8d; font-size: 14px; }

        .action-section { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .panel { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 100%; box-sizing: border-box; }
        .panel h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .menu-btn { width: 100%; height: 120px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; background-color: #2c3e50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .menu-btn:hover { background-color: #34495e; transform: translateY(-2px); }

        .list-group { list-style: none; padding: 0; margin: 0; max-height: 340px; overflow-y: auto; }
        .list-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; color: white; font-weight: bold; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; width: 800px; border-radius: 10px; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; background: none; border: none; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; vertical-align: middle; }
        .data-table th { background-color: #f8f9fa; font-weight: 600; }

        .btn-approve-exit { padding: 5px 10px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-approve { padding: 5px 10px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .btn-reject { padding: 5px 10px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; }

        .penalty-layout { display: flex; gap: 20px; height: 450px; }
        .student-search-box { flex: 1; border-right: 1px solid #eee; padding-right: 20px; display: flex; flex-direction: column; }
        .penalty-form-box { flex: 1; padding-left: 10px; display: flex; flex-direction: column; justify-content: center; opacity: 0.5; pointer-events: none; }
        .penalty-form-box.active { opacity: 1; pointer-events: all; }

        .search-input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .search-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-search { padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }

        .search-result-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; border: 1px solid #eee; border-radius: 4px; }
        .search-result-item { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .search-result-item:hover { background-color: #f0f8ff; }
        .search-result-item.selected { background-color: #e1f0fa; border-left: 4px solid #3498db; }

        .penalty-score { float: right; font-weight: bold; font-size: 13px; padding: 2px 6px; border-radius: 4px; }
        .score-plus { color: #27ae60; background: #eafaf1; }
        .score-minus { color: #e74c3c; background: #fce4e4; }
        .score-zero { color: #7f8c8d; background: #f0f0f0; }

        .form-label { font-weight: bold; display: block; margin-top: 10px; margin-bottom: 5px; font-size: 14px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .form-textarea { height: 80px; resize: none; }
        .btn-submit { width: 100%; padding: 12px; background: #e67e22; color: white; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer; font-weight: bold; }

        .notice-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .notice-area { height: 100px; resize: vertical; }
        .notice-list { list-style: none; padding: 0; margin-top: 20px; }
        .notice-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .n-title { font-weight: bold; font-size: 16px; }
        .n-meta { font-size: 12px; color: #999; margin-top: 5px; }
        .n-content { margin-top: 5px; color: #555; white-space: pre-wrap; }
        .status-btn { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; color: white; font-size: 12px; margin-right: 5px; }
        .btn-process { background-color: #3498db; }
        .btn-complete { background-color: #27ae60; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ›¡ï¸ ê¸°ìˆ™ì‚¬ ê´€ë¦¬ì ì‹œìŠ¤í…œ</h1>
    <div>
        <span id="managerName" style="margin-right: 15px; font-weight: bold;">ê´€ë¦¬ìë‹˜</span>
        <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">ì´ ê±°ì£¼ í•™ìƒ</div>
            <div class="stat-number" id="statTotal">0ëª…</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì˜¤ëŠ˜ì˜ ì™¸ë°•ì</div>
            <div class="stat-number" id="statAbsence" style="color: #e74c3c;">0ëª…</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸° ì™¸ë°•</div>
            <div class="stat-number" id="statPendingAbsence" style="color: #f39c12;">0ê±´</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì²˜ë¦¬ ëŒ€ê¸° ë¯¼ì›</div>
            <div class="stat-number" id="statPendingComplaint" style="color: #8e44ad;">0ê±´</div>
        </div>
    </div>

    <div class="action-section">
        <div class="panel">
            <h3>âš¡ ì£¼ìš” ì—…ë¬´</h3>
            <div class="menu-grid">
                <button class="menu-btn" onclick="location.href='/index.html'">ğŸ“ í•™ìƒ ê´€ë¦¬</button>
                <button class="menu-btn" onclick="openApprovalModal()">ğŸ“… ì™¸ë°• ìŠ¹ì¸</button>
                <button class="menu-btn" onclick="openPenaltyModal()">ğŸš¨ ìƒë²Œì  ê´€ë¦¬</button>
                <button class="menu-btn" onclick="openComplaintModal()">ğŸ› ï¸ ì‹œì„¤/ë¯¼ì›</button>
                <button class="menu-btn" onclick="location.href='/room_management.html'">ğŸ¢ í˜¸ì‹¤ ê´€ë¦¬</button>
                <button class="menu-btn" onclick="openNoticeModal()">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
            </div>
        </div>
        <div class="panel">
            <h3>ğŸ”” ì²˜ë¦¬ ëŒ€ê¸° ëª©ë¡</h3>
            <ul id="pendingList" class="list-group">
                <li class="list-item" style="color:#999; text-align:center; padding:20px;">ë¡œë”© ì¤‘...</li>
            </ul>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ë“¤ -->
<!-- í‡´ì†Œ ì‹ ì²­ ìŠ¹ì¸ ëª¨ë‹¬ -->
<div id="exitApprovalModal" class="modal">
    <div class="modal-content" style="width: 600px;">
        <button class="close-btn" onclick="closeModal('exitApprovalModal')">Ã—</button>
        <h2 style="margin-top:0;">ğŸšª í‡´ì†Œ ì‹ ì²­ ìŠ¹ì¸</h2>
        <table class="data-table">
            <thead>
            <tr>
                <th>í•™ë²ˆ</th>
                <th>ì´ë¦„</th>
                <th>í˜¸ì‹¤</th>
                <th>ì‹ ì²­ì¼</th>
                <th>ì²˜ë¦¬</th>
            </tr>
            </thead>
            <tbody id="exitRequestList"></tbody>
        </table>
    </div>
</div>

<!-- ì™¸ë°• ìŠ¹ì¸ ëª¨ë‹¬ -->
<div id="approvalModal" class="modal">
    <div class="modal-content" style="width: 700px;">
        <button class="close-btn" onclick="closeModal('approvalModal')">Ã—</button>
        <h2 style="margin-top:0;">ğŸ“… ì™¸ë°• ì‹ ì²­ ìŠ¹ì¸</h2>
        <table class="data-table">
            <thead>
            <tr>
                <th>í•™ìƒ ì •ë³´</th>
                <th>ê¸°ê°„</th>
                <th>ì‚¬ìœ </th>
                <th>ì²˜ë¦¬</th>
            </tr>
            </thead>
            <tbody id="approvalList"></tbody>
        </table>
    </div>
</div>

<!-- ìƒë²Œì  ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="penaltyModal" class="modal">
    <div class="modal-content" style="width: 850px;">
        <button class="close-btn" onclick="closeModal('penaltyModal')">Ã—</button>
        <h2 style="margin-top:0;">ğŸš¨ ìƒë²Œì  ê´€ë¦¬</h2>

        <div class="penalty-layout">
            <!-- ì™¼ìª½: í•™ìƒ ê²€ìƒ‰ -->
            <div class="student-search-box">
                <h4 style="margin-top:0;">1. í•™ìƒ ê²€ìƒ‰</h4>
                <div class="search-input-group">
                    <input type="text" id="pSearchKeyword" class="search-input" placeholder="ì´ë¦„/í•™ë²ˆ (ë¹ˆì¹¸ ì‹œ ì „ì²´)" onkeyup="if(event.key==='Enter') searchStudent()">
                    <button class="btn-search" onclick="searchStudent()">ê²€ìƒ‰</button>
                </div>
                <ul id="pStudentList" class="search-result-list"></ul>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì ìˆ˜ ë¶€ì—¬ -->
            <div id="penaltyFormBox" class="penalty-form-box">
                <h4 style="margin-top:0;">2. ì ìˆ˜ ë¶€ì—¬</h4>
                <div style="background:#f4f6f8; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <span id="selectedStudentName" style="font-weight:bold; color:#2c3e50;">í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span><br>
                    <span id="selectedStudentPenalty" style="font-size:13px; font-weight:bold;"></span>
                </div>

                <input type="hidden" id="pTargetSid">

                <label class="form-label">êµ¬ë¶„</label>
                <select id="pType" class="form-select">
                    <option value="ë²Œì ">ğŸ”´ ë²Œì  (ë§ˆì´ë„ˆìŠ¤)</option>
                    <option value="ìƒì ">ğŸŸ¢ ìƒì  (í”ŒëŸ¬ìŠ¤)</option>
                </select>

                <label class="form-label">ì ìˆ˜</label>
                <input type="number" id="pPoints" class="form-input" placeholder="ì ìˆ˜ ì…ë ¥ (ì–‘ìˆ˜ë¡œ ì…ë ¥)">

                <label class="form-label">ì‚¬ìœ </label>
                <textarea id="pReason" class="form-textarea" placeholder="ë¶€ì—¬ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>

                <button class="btn-submit" onclick="givePenalty()">ë¶€ì—¬í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ë¯¼ì› ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="complaintModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('complaintModal')">Ã—</button>
        <h2 style="margin-top:0;">ğŸ› ï¸ ì‹œì„¤ ìˆ˜ë¦¬ ë° ë¯¼ì› ê´€ë¦¬</h2>
        <table class="data-table">
            <thead>
            <tr>
                <th>ìƒíƒœ</th>
                <th>ìœ„ì¹˜</th>
                <th>ë‚´ìš©</th>
                <th>ì ‘ìˆ˜ì¼</th>
                <th>ì²˜ë¦¬</th>
            </tr>
            </thead>
            <tbody id="complaintList"></tbody>
        </table>
    </div>
</div>

<!-- ê³µì§€ì‚¬í•­ ëª¨ë‹¬ -->
<div id="noticeModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('noticeModal')">Ã—</button>
        <h2 style="margin-top:0;">ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h2>
        <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-top:10px;">
            <input type="text" id="nTitle" class="notice-input" placeholder="ì œëª©">
            <textarea id="nContent" class="notice-input notice-area" placeholder="ë‚´ìš©"></textarea>
            <div style="text-align:right;">
                <button onclick="createNotice()" style="padding:5px 15px; background:#3498db; color:white; border:none; border-radius:4px; cursor:pointer;">ë“±ë¡</button>
            </div>
        </div>
        <ul id="noticeList" class="notice-list"></ul>
    </div>
</div>

<script>
    let globalSelectedSid = null;

    window.onload = function() {
        loadManagerInfo();
        loadStats();
        loadPendingItems();
        loadExitRequests();
    };

    // ê´€ë¦¬ì ì •ë³´ ë¡œë“œ
    function loadManagerInfo() {
        fetch('/api/current-user')
            .then(r => r.json())
            .then(d => {
                if(!d.loggedIn || d.role !== 'MANAGER') {
                    location.href = '/login.html';
                    return;
                }
                document.getElementById('managerName').innerText = (d.user.mname || "ê´€ë¦¬ì") + "ë‹˜";
            });
    }

    // í†µê³„ ë¡œë“œ
    async function loadStats() {
        try {
            const r = await fetch('/api/manager/stats');
            if(r.ok) {
                const s = await r.json();
                document.getElementById('statTotal').innerText = s.totalStudents + "ëª…";
                document.getElementById('statAbsence').innerText = s.todayAbsence + "ëª…";
                document.getElementById('statPendingAbsence').innerText = s.pendingAbsence + "ê±´";
                document.getElementById('statPendingComplaint').innerText = s.pendingComplaints + "ê±´";
            }
        } catch(e) {
            console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // ëŒ€ê¸° ëª©ë¡ ë¡œë“œ
    async function loadPendingItems() {
        try {
            const response = await fetch('/api/manager/pending-items');
            const items = await response.json();
            const list = document.getElementById('pendingList');
            list.innerHTML = '';

            if (items.length === 0) {
                list.innerHTML = '<li class="list-item" style="color:#999; text-align:center;">ëŒ€ê¸° ì¤‘ì¸ í•­ëª© ì—†ìŒ</li>';
                return;
            }

            items.forEach(item => {
                let color = item.type === 'ì™¸ë°•' ? '#27ae60' : (item.type === 'í‡´ì†Œ' ? '#e74c3c' : '#9b59b6');
                list.innerHTML += `
                    <li class="list-item">
                        <span><strong style="color:${color}">[${item.type}]</strong> ${item.text}</span>
                        <span class="badge" style="background-color:${color}">${item.status}</span>
                    </li>`;
            });
        } catch(e) {
            console.error('ëŒ€ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // í‡´ì†Œ ì‹ ì²­ ëª¨ë‹¬ ì—´ê¸°
    function openExitApprovalModal() {
        document.getElementById('exitApprovalModal').style.display = 'flex';
        loadExitRequests();
    }

    // í‡´ì†Œ ì‹ ì²­ ëª©ë¡ ë¡œë“œ
    async function loadExitRequests() {
        const res = await fetch('/api/manager/exit/requests');
        const list = await res.json();
        const tbody = document.getElementById('exitRequestList');
        tbody.innerHTML = '';

        if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">í‡´ì†Œ ì‹ ì²­ ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        list.forEach(item => {
            const reqDate = item.Exit_Request_Date ? item.Exit_Request_Date.substring(0, 10) : 'N/A';
            tbody.innerHTML += `
                <tr>
                    <td>${item.SID}</td>
                    <td>${item.Name}</td>
                    <td>${item.Room_No}í˜¸</td>
                    <td>${reqDate}</td>
                    <td>
                        <button class="btn-approve-exit" onclick="processExitApproval('${item.SID}')">ìŠ¹ì¸</button>
                    </td>
                </tr>`;
        });
    }

    // í‡´ì†Œ ìŠ¹ì¸ ì²˜ë¦¬
    async function processExitApproval(sid) {
        if(!confirm(`[${sid}] í•™ìƒì„ ìµœì¢… í‡´ì†Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        await fetch('/api/manager/student/exit/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sid: sid })
        });

        alert("í‡´ì†Œ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadExitRequests();
        loadStats();
    }

    // ìƒë²Œì  ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
    function openPenaltyModal() {
        document.getElementById('penaltyModal').style.display = 'flex';
        document.getElementById('pSearchKeyword').value = '';
        resetPenaltyForm();
        searchStudent('');
    }

    // í•™ìƒ ê²€ìƒ‰
    async function searchStudent(keyword) {
        if (keyword === undefined) keyword = document.getElementById('pSearchKeyword').value;

        const res = await fetch(`/api/manager/students/search?keyword=${keyword}`);
        const students = await res.json();
        const list = document.getElementById('pStudentList');
        list.innerHTML = '';

        if(students.length === 0) {
            list.innerHTML = '<li style="padding:20px; text-align:center; color:#999;">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            return;
        }

        students.forEach(s => {
            let scoreClass = s.totalPenalty > 0 ? 'score-plus' : (s.totalPenalty < 0 ? 'score-minus' : 'score-zero');
            let scoreText = s.totalPenalty > 0 ? `+${s.totalPenalty}ì ` : s.totalPenalty + "ì ";

            const li = document.createElement('li');
            li.className = 'search-result-item';
            li.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <strong>${s.name}</strong> <small>(${s.sid})</small><br>
                        <span style="font-size:12px;color:#777;">${s.deptName} | ${s.roomNo}í˜¸</span>
                    </div>
                    <span class="penalty-score ${scoreClass}">${scoreText}</span>
                </div>`;

            li.onclick = () => selectStudent(s, li, scoreText, scoreClass);
            list.appendChild(li);
        });
    }

    // í•™ìƒ ì„ íƒ
    function selectStudent(s, el, scoreText, scoreClass) {
        document.querySelectorAll('.search-result-item').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');

        document.getElementById('penaltyFormBox').classList.add('active');
        document.getElementById('selectedStudentName').innerText = `${s.name} (${s.sid}) - ${s.roomNo}í˜¸`;
        document.getElementById('selectedStudentPenalty').innerText = `ëˆ„ì  ì ìˆ˜: ${scoreText}`;

        const scoreEl = document.getElementById('selectedStudentPenalty');
        scoreEl.className = "";
        if(scoreClass === 'score-plus') scoreEl.style.color = '#27ae60';
        else if(scoreClass === 'score-minus') scoreEl.style.color = '#e74c3c';
        else scoreEl.style.color = '#7f8c8d';

        document.getElementById('pTargetSid').value = s.sid;
        globalSelectedSid = s.sid;
    }

    // ìƒë²Œì  í¼ ì´ˆê¸°í™”
    function resetPenaltyForm() {
        document.getElementById('penaltyFormBox').classList.remove('active');
        document.getElementById('selectedStudentName').innerText = "í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        document.getElementById('selectedStudentPenalty').innerText = "";
        document.getElementById('pTargetSid').value = "";
        document.getElementById('pPoints').value = "";
        document.getElementById('pReason').value = "";
    }

    // ìƒë²Œì  ë¶€ì—¬
    async function givePenalty() {
        const sid = document.getElementById('pTargetSid').value;
        const type = document.getElementById('pType').value;
        const points = document.getElementById('pPoints').value;
        const reason = document.getElementById('pReason').value;

        if(!sid || !points || !reason) return alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

        await fetch('/api/manager/penalty/give', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                studentId: sid,
                type: type,
                points: parseInt(points),
                reason: reason
            })
        });

        alert("ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        const currentKeyword = document.getElementById('pSearchKeyword').value;
        searchStudent(currentKeyword);
        resetPenaltyForm();
    }

    // ì™¸ë°• ìŠ¹ì¸ ëª¨ë‹¬ ì—´ê¸°
    function openApprovalModal() {
        document.getElementById('approvalModal').style.display = 'flex';
        loadApprovalList();
    }

    // ì™¸ë°• ìŠ¹ì¸ ëª©ë¡ ë¡œë“œ
    async function loadApprovalList() {
        const res = await fetch('/api/manager/absence/pending');
        const list = await res.json();
        const tbody = document.getElementById('approvalList');
        tbody.innerHTML = '';

        if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ ì—†ìŒ</td></tr>';
            return;
        }

        list.forEach(i => {
            tbody.innerHTML += `
                <tr>
                    <td>${i.Name}<br><small>${i.SID} | ${i.Dept_Name}</small></td>
                    <td>${i.Start_Date} ~ ${i.Return_Date}</td>
                    <td>${i.Reason}</td>
                    <td>
                        <button class="btn-approve" onclick="processApproval('${i.Absence_ID}','Approved')">ìŠ¹ì¸</button>
                        <button class="btn-reject" onclick="processApproval('${i.Absence_ID}','Rejected')">ë°˜ë ¤</button>
                    </td>
                </tr>`;
        });
    }

    // ì™¸ë°• ìŠ¹ì¸/ë°˜ë ¤ ì²˜ë¦¬
    async function processApproval(id, st) {
        if(!confirm('ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        await fetch('/api/manager/absence/approval', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: id, status: st})
        });

        alert('ì²˜ë¦¬ì™„ë£Œ');
        loadApprovalList();
        loadStats();
        loadPendingItems();
    }

    // ë¯¼ì› ëª¨ë‹¬ ì—´ê¸°
    function openComplaintModal() {
        document.getElementById('complaintModal').style.display = 'flex';
        loadComplaints();
    }

    // â˜… ë¯¼ì› ëª©ë¡ ë¡œë“œ (ìˆ˜ì •ë¨)
    async function loadComplaints() {
        try {
            const res = await fetch('/api/manager/complaints');
            const list = await res.json();
            const tbody = document.getElementById('complaintList');
            tbody.innerHTML = '';

            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">ì ‘ìˆ˜ëœ ë¯¼ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            list.forEach(c => {
                let btnProcess = '';
                let btnComplete = '';

                // ìƒíƒœë³„ ë²„íŠ¼ í‘œì‹œ ë¡œì§
                if(c.Status === 'ì ‘ìˆ˜') {
                    btnProcess = `<button class="status-btn btn-process" onclick="updateComplaint('${c.Comp_ID}', 'ì²˜ë¦¬ì¤‘')">ì²˜ë¦¬ì¤‘ìœ¼ë¡œ</button>`;
                    btnComplete = `<button class="status-btn btn-complete" onclick="updateComplaint('${c.Comp_ID}', 'ì™„ë£Œ')">ì™„ë£Œ</button>`;
                } else if(c.Status === 'ì²˜ë¦¬ì¤‘') {
                    btnComplete = `<button class="status-btn btn-complete" onclick="updateComplaint('${c.Comp_ID}', 'ì™„ë£Œ')">ì™„ë£Œ</button>`;
                } else if(c.Status === 'ì™„ë£Œ') {
                    btnComplete = '<span style="color:#27ae60; font-weight:bold;">âœ“ ì™„ë£Œë¨</span>';
                }

                let statusColor = c.Status === 'ì ‘ìˆ˜' ? 'red' : (c.Status === 'ì²˜ë¦¬ì¤‘' ? 'orange' : 'green');

                tbody.innerHTML += `
                    <tr>
                        <td style="color:${statusColor}; font-weight:bold;">${c.Status}</td>
                        <td>${c.Room_No}í˜¸</td>
                        <td>
                            <strong>${c.Content}</strong><br>
                            <small style="color:#888;">${c.StudentName} (${c.SID})</small>
                        </td>
                        <td>${c.Date}</td>
                        <td>
                            ${btnProcess}
                            ${btnComplete}
                        </td>
                    </tr>`;
            });
        } catch(error) {
            console.error('ë¯¼ì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // â˜… ë¯¼ì› ìƒíƒœ ë³€ê²½ (ìˆ˜ì •ë¨)
    async function updateComplaint(id, status) {
        if(!confirm(`ìƒíƒœë¥¼ '${status}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const response = await fetch('/api/manager/complaint/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: id,
                    status: status
                })
            });

            if(response.ok) {
                alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                await loadComplaints(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadStats(); // í†µê³„ ì—…ë°ì´íŠ¸
                await loadPendingItems(); // ëŒ€ê¸° ëª©ë¡ ì—…ë°ì´íŠ¸
            } else {
                const errorText = await response.text();
                console.error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:', errorText);
                alert("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        } catch(error) {
            console.error('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ê³µì§€ì‚¬í•­ ëª¨ë‹¬ ì—´ê¸°
    function openNoticeModal() {
        document.getElementById('noticeModal').style.display = 'flex';
        loadNotices();
    }

    // ê³µì§€ì‚¬í•­ ëª©ë¡ ë¡œë“œ
    async function loadNotices() {
        const res = await fetch('/api/notices');
        const list = await res.json();
        const ul = document.getElementById('noticeList');
        ul.innerHTML = '';

        list.forEach(n => {
            ul.innerHTML += `
                <li class="notice-item">
                    <div class="n-title">${n.title}</div>
                    <div class="n-content">${n.content}</div>
                    <div class="n-meta">${n.writer} | ${n.regDate}</div>
                </li>`;
        });
    }

    // ê³µì§€ì‚¬í•­ ë“±ë¡
    async function createNotice() {
        const title = document.getElementById('nTitle').value;
        const content = document.getElementById('nContent').value;
        const writer = document.getElementById('managerName').innerText.replace('ë‹˜', '');

        if(!title || !content) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

        await fetch('/api/notices', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content, writer })
        });

        alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById('nTitle').value = '';
        document.getElementById('nContent').value = '';
        loadNotices();
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
        if(confirm("ë¡œê·¸ì•„ì›ƒ?"))
            fetch('/api/logout', {method: 'POST'}).then(() => location.href = '/login.html');
    }
</script>
</body>
</html>