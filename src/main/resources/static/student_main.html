<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ì„œë¹„ìŠ¤ - ê¸°ìˆ™ì‚¬ ì‹œìŠ¤í…œ</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; }
        header { background-color: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 20px; }
        .header-buttons { display: flex; gap: 10px; align-items: center; }
        .btn-small { padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; border: none; font-size: 14px; color: white; transition: 0.3s; }
        .logout-btn { background-color: #e74c3c; } .logout-btn:hover { background-color: #c0392b; }
        .pwd-btn { background-color: #34495e; border: 1px solid #4e637a; } .pwd-btn:hover { background-color: #4e637a; }

        .container { max-width: 1000px; margin: 30px auto; padding: 20px; display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .info-item { margin-bottom: 12px; font-size: 15px; color: #555; display: flex; justify-content: space-between; }
        .info-label { font-weight: bold; color: #34495e; }

        /* ì•¡ì…˜ ë²„íŠ¼ ê·¸ë¦¬ë“œ */
        .action-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .split-container { display: flex; gap: 10px; width: 100%; height: 120px; }
        .btn-half { flex: 1; height: 100%; padding: 0; font-size: 15px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; color: white; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; background-color: #3498db; }
        .btn-half:hover { background-color: #2980b9; transform: translateY(-2px); }
        .btn-exit { background-color: #e74c3c !important; } .btn-exit:hover { background-color: #c0392b !important; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 500px; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-wide { width: 900px; }

        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #999; background: none; border: none; }

        /* ë‚´ì—­ ë¶„í•  ë ˆì´ì•„ì›ƒ */
        .history-split-layout { display: flex; gap: 20px; height: 400px; }
        .history-col { flex: 1; display: flex; flex-direction: column; border: 1px solid #eee; border-radius: 8px; padding: 10px; background-color: #fcfcfc; }
        .history-col h4 { margin: 0 0 10px 0; text-align: center; padding-bottom: 10px; border-bottom: 2px solid #ddd; color: #555; }

        .history-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .history-item { background: white; border: 1px solid #eee; padding: 12px; margin-bottom: 8px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; color: white; font-weight: bold; }
        .bg-pending { background-color: #f39c12; }
        .bg-approved { background-color: #27ae60; }
        .bg-rejected { background-color: #e74c3c; }
        .bg-process { background-color: #3498db; }
        .bg-complete { background-color: #27ae60; }

        .form-group { text-align: left; margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        .form-group textarea { height: 80px; resize: none; }
        .modal-actions { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .btn-confirm { background-color: #2c3e50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background-color: #95a5a6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .score-card { text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px; }
        .score-title { font-size: 14px; color: #7f8c8d; margin-bottom: 5px; }
        .score-value { font-size: 36px; font-weight: bold; }
        .score-plus { color: #27ae60; } .score-minus { color: #e74c3c; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ  ê¸°ìˆ™ì‚¬ í•™ìƒ ì„œë¹„ìŠ¤</h1>
    <div class="header-buttons">
        <span id="welcomeMsg" style="font-weight: bold; margin-right: 10px;"></span>
        <button class="btn-small pwd-btn" onclick="openModal('pwdModal')">ğŸ”’ ë¹„ë²ˆë³€ê²½</button>
        <button class="btn-small logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>

<div class="container">
    <div class="card">
        <h3>ğŸ‘¤ ë‚´ ì •ë³´</h3>
        <div id="myInfoContent">
            <div class="info-item"><span class="info-label">í•™ë²ˆ</span> <span id="infoSid"></span></div>
            <div class="info-item"><span class="info-label">ì´ë¦„</span> <span id="infoName"></span></div>
            <div class="info-item"><span class="info-label">í•™ê³¼</span> <span id="infoDept"></span></div>
            <div class="info-item"><span class="info-label">ì„±ë³„</span> <span id="infoGender"></span></div>
            <div class="info-item"><span class="info-label">í˜¸ì‹¤</span> <span id="infoRoom" style="color: #e67e22; font-weight: bold;"></span></div>
        </div>
    </div>

    <div class="card">
        <h3>âš¡ ë¹ ë¥¸ ì„œë¹„ìŠ¤</h3>
        <div class="action-grid">
            <!-- 1. ì™¸ë°• ì„¹ì…˜ -->
            <div class="split-container">
                <button class="btn-half" onclick="openModal('absenceModal')">ğŸ“… ì™¸ë°• ì‹ ì²­</button>
                <button class="btn-half" onclick="openHistoryModal()">ğŸ“‹ ì™¸ë°• ë‚´ì—­</button>
            </div>
            <!-- 2. ìˆ˜ë¦¬ ì„¹ì…˜ -->
            <div class="split-container">
                <button class="btn-half" onclick="openModal('repairModal')">ğŸ› ï¸ ìˆ˜ë¦¬ ìš”ì²­</button>
                <button class="btn-half" onclick="openComplaintHistoryModal('REPAIR')">ğŸ“ ìˆ˜ë¦¬ ë‚´ì—­</button>
            </div>
            <!-- 3. ë¯¼ì› ì„¹ì…˜ -->
            <div class="split-container">
                <button class="btn-half" onclick="openModal('complaintModal')">ğŸ—£ï¸ ë¯¼ì› ì ‘ìˆ˜</button>
                <button class="btn-half" onclick="openComplaintHistoryModal('COMPLAINT')">ğŸ“¨ ë¯¼ì› ë‚´ì—­</button>
            </div>
            <!-- 4. ìƒë²Œì /í‡´ì†Œ ì„¹ì…˜ -->
            <div class="split-container">
                <button class="btn-half" onclick="openPenaltyModal()">ğŸ“Š ìƒë²Œì  í™•ì¸</button>
                <button class="btn-half btn-exit" onclick="requestExit()">ğŸšª í‡´ì†Œ ì‹ ì²­</button>
            </div>
        </div>
    </div>
</div>

<!-- ì™¸ë°• ë‚´ì—­ ëª¨ë‹¬ (ì¢Œìš° ë¶„í• ) -->
<div id="historyModal" class="modal">
    <div class="modal-content modal-wide">
        <button class="close-btn" onclick="closeModal('historyModal')">Ã—</button>
        <h3>ğŸ“‹ ì™¸ë°• ì‹ ì²­ ë‚´ì—­</h3>

        <div class="history-split-layout">
            <!-- ì™¼ìª½: ëŒ€ê¸° ì¤‘ -->
            <div class="history-col">
                <h4 style="color:#f39c12;">â³ ìŠ¹ì¸ ëŒ€ê¸°</h4>
                <ul id="pendingHistoryList" class="history-list"></ul>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì²˜ë¦¬ ì™„ë£Œ (ê³¼ê±°) -->
            <div class="history-col">
                <h4 style="color:#27ae60;">âœ… ì²˜ë¦¬ ì™„ë£Œ (ìŠ¹ì¸/ë°˜ë ¤)</h4>
                <ul id="pastHistoryList" class="history-list"></ul>
            </div>
        </div>
    </div>
</div>

<!-- ë‚˜ë¨¸ì§€ ëª¨ë‹¬ë“¤ -->
<div id="penaltyModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('penaltyModal')">Ã—</button>
        <h3>ğŸ“Š ìƒë²Œì  ë‚´ì—­</h3>
        <div class="score-card">
            <div class="score-title">ë‚˜ì˜ ëˆ„ì  ì ìˆ˜</div>
            <div id="myTotalScore" class="score-value">0ì </div>
        </div>
        <ul id="penaltyList" class="history-list"></ul>
    </div>
</div>

<div id="absenceModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('absenceModal')">Ã—</button>
        <h3>ğŸ“… ì™¸ë°• ì‹ ì²­</h3>
        <div class="form-group">
            <label>ì‹œì‘ì¼</label>
            <input type="date" id="startDate">
        </div>
        <div class="form-group">
            <label>ë³µê·€ì¼</label>
            <input type="date" id="returnDate">
        </div>
        <div class="form-group">
            <label>ì‚¬ìœ </label>
            <textarea id="reason" placeholder="ì˜ˆ: ë³¸ê°€ ë°©ë¬¸"></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn-confirm" onclick="applyAbsence()">ì‹ ì²­í•˜ê¸°</button>
        </div>
    </div>
</div>

<div id="repairModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('repairModal')">Ã—</button>
        <h3>ğŸ› ï¸ ì‹œì„¤ë¬¼ ìˆ˜ë¦¬ ìš”ì²­</h3>
        <p style="color:#7f8c8d; font-size:14px;">ë³¸ì¸ í˜¸ì‹¤(<span id="repairRoomNo"></span>) ì‹œì„¤ë¬¼ ì‹ ê³ </p>
        <div class="form-group">
            <label>ê³ ì¥ ì‹œì„¤ë¬¼</label>
            <select id="repairFacility">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            </select>
        </div>
        <div class="form-group">
            <label>ë‚´ìš©</label>
            <textarea id="repairContent" placeholder="ê³ ì¥ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn-confirm" onclick="applyRepair()">ìš”ì²­í•˜ê¸°</button>
        </div>
    </div>
</div>

<div id="complaintModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('complaintModal')">Ã—</button>
        <h3>ğŸ—£ï¸ ì¼ë°˜ ë¯¼ì› ì ‘ìˆ˜</h3>
        <div class="form-group">
            <label>ë‚´ìš©</label>
            <textarea id="complaintContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn-confirm" onclick="applyComplaint()">ì ‘ìˆ˜í•˜ê¸°</button>
        </div>
    </div>
</div>

<div id="complaintHistoryModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('complaintHistoryModal')">Ã—</button>
        <h3 id="complaintHistoryTitle">ğŸ“ ìš”ì²­ ë‚´ì—­</h3>
        <ul id="complaintHistoryList" class="history-list"></ul>
    </div>
</div>

<div id="pwdModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('pwdModal')">Ã—</button>
        <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
        <input type="password" id="currentPwd" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" style="width:100%;padding:10px;margin-bottom:5px;">
        <input type="password" id="newPwd" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="width:100%;padding:10px;margin-bottom:5px;">
        <input type="password" id="confirmPwd" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" style="width:100%;padding:10px;">
        <div class="modal-actions">
            <button class="btn-confirm" onclick="changePassword()">ë³€ê²½í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    let myRoomNo = "";

    window.onload = function() {
        fetch('/api/current-user').then(res => res.json()).then(data => {
            if (!data.loggedIn || data.role !== 'STUDENT') {
                location.href = '/login.html';
                return;
            }
            const user = data.user;
            document.getElementById('welcomeMsg').innerText = `${user.name}ë‹˜`;
            document.getElementById('infoSid').innerText = user.sid;
            document.getElementById('infoName').innerText = user.name;
            document.getElementById('infoDept').innerText = user.deptName;
            document.getElementById('infoGender').innerText = user.gender;
            document.getElementById('infoRoom').innerText = user.roomNo + 'í˜¸';
            document.getElementById('repairRoomNo').innerText = user.roomNo + 'í˜¸';
            myRoomNo = user.roomNo;
        });
    };

    // â˜… ì™¸ë°• ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ (ê´€ë¦¬ì ì •ë³´ í¬í•¨)
    function openHistoryModal() {
        document.getElementById('historyModal').style.display='flex';
        loadHistory();
    }

    async function loadHistory() {
        try {
            const res = await fetch('/api/absence/history');
            const list = await res.json();

            const pendingUl = document.getElementById('pendingHistoryList');
            const pastUl = document.getElementById('pastHistoryList');

            pendingUl.innerHTML = '';
            pastUl.innerHTML = '';

            let hasPending = false;
            let hasPast = false;

            list.forEach(item => {
                let badgeClass = 'bg-pending';
                let statusText = 'ëŒ€ê¸°';
                let targetUl = pendingUl;
                let managerInfo = ''; // â˜… ê´€ë¦¬ì ì •ë³´ ì¶”ê°€

                if (item.Status === 'Pending') {
                    hasPending = true;
                    targetUl = pendingUl;
                } else {
                    hasPast = true;
                    targetUl = pastUl;
                    if(item.Status === 'Approved') {
                        badgeClass = 'bg-approved';
                        statusText = 'ìŠ¹ì¸';
                    }
                    else if(item.Status === 'Rejected') {
                        badgeClass = 'bg-rejected';
                        statusText = 'ë°˜ë ¤';
                    }

                    // â˜… ì²˜ë¦¬í•œ ê´€ë¦¬ì ì •ë³´ í‘œì‹œ
                    if (item.Manager_Name) {
                        managerInfo = `<br><span style="font-size:12px; color:#999;">ì²˜ë¦¬ì: ${item.Manager_Name}</span>`;
                    }
                }

                targetUl.innerHTML += `
                    <li class="history-item">
                        <div>
                            <strong>${item.Start_Date} ~ ${item.Return_Date}</strong><br>
                            <span style="color:#7f8c8d; font-size:13px;">${item.Reason}</span>
                            ${managerInfo}
                        </div>
                        <span class="badge ${badgeClass}">${statusText}</span>
                    </li>`;
            });

            if (!hasPending) pendingUl.innerHTML = '<li style="text-align:center; color:#ccc; padding:20px;">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            if (!hasPast) pastUl.innerHTML = '<li style="text-align:center; color:#ccc; padding:20px;">ê³¼ê±° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';

        } catch(e) { console.error(e); }
    }

    // ì™¸ë°• ì‹ ì²­
    async function applyAbsence() {
        const s = document.getElementById('startDate').value;
        const r = document.getElementById('returnDate').value;
        const rs = document.getElementById('reason').value;

        if(!s || !r || !rs) return alert("ì…ë ¥ í•„ìš”");

        await fetch('/api/absence/apply', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({startDate:s, returnDate:r, reason:rs})
        });

        alert("ì‹ ì²­ ì™„ë£Œ");
        closeModal('absenceModal');
    }

    // ë‚´ í˜¸ì‹¤ ì‹œì„¤ë¬¼ ëª©ë¡ ë¡œë“œ
    async function loadMyFacilities() {
        if(!myRoomNo) return;
        try {
            const res = await fetch(`/api/rooms/${myRoomNo}/facilities`);
            const facilities = await res.json();
            const select = document.getElementById('repairFacility');
            select.innerHTML = '<option value="">ì‹œì„¤ë¬¼ì„ ì„ íƒí•˜ì„¸ìš” (ì„ íƒì‚¬í•­)</option>';
            facilities.forEach(f => {
                const option = document.createElement('option');
                option.value = f.Fac_ID;
                option.textContent = `${f.Name} (${f.Status})`;
                select.appendChild(option);
            });
        } catch(e) {}
    }

    // ìˆ˜ë¦¬ ìš”ì²­
    async function applyRepair() {
        const content = document.getElementById('repairContent').value;
        const facilityId = document.getElementById('repairFacility').value;

        if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        try {
            const res = await fetch('/api/complaint/apply', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ content: content, facilityId: facilityId })
            });
            const result = await res.json();
            alert(result.message);
            if(result.success) {
                closeModal('repairModal');
                document.getElementById('repairContent').value = '';
            }
        } catch(e) {
            alert("ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // ì¼ë°˜ ë¯¼ì› ì ‘ìˆ˜
    async function applyComplaint() {
        const content = document.getElementById('complaintContent').value;

        if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        try {
            const res = await fetch('/api/complaint/apply', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ content: content })
            });
            const result = await res.json();
            alert("ë¯¼ì›ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            if(result.success) {
                closeModal('complaintModal');
                document.getElementById('complaintContent').value = '';
            }
        } catch(e) {
            alert("ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // í‡´ì†Œ ì‹ ì²­
    async function requestExit() {
        if(!confirm("ì •ë§ë¡œ í‡´ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í™•ì¸ ì‹œ ì¦‰ì‹œ ì²˜ë¦¬ë˜ë©° ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.)")) return;

        try {
            const res = await fetch('/students/request-exit', { method: 'POST' });
            const result = await res.json();
            alert(result.message);
            if (result.success) {
                window.location.href = '/login.html';
            }
        } catch (e) {
            alert("ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // ìƒë²Œì  ëª¨ë‹¬ ì—´ê¸°
    function openPenaltyModal() {
        document.getElementById('penaltyModal').style.display='flex';
        loadPenaltyHistory();
    }

    // ìƒë²Œì  ë‚´ì—­ ë¡œë“œ
    async function loadPenaltyHistory() {
        try {
            const res = await fetch('/api/penalty/history');
            if (!res.ok) throw new Error("API ì˜¤ë¥˜");

            const data = await res.json();
            const totalScore = data.totalPenalty;
            const scoreEl = document.getElementById('myTotalScore');

            if (totalScore > 0) {
                scoreEl.innerText = `+${totalScore}ì `;
                scoreEl.className = "score-value score-plus";
            } else if (totalScore < 0) {
                scoreEl.innerText = `${totalScore}ì `;
                scoreEl.className = "score-value score-minus";
            } else {
                scoreEl.innerText = "0ì ";
                scoreEl.className = "score-value";
            }

            const list = data.history;
            const ul = document.getElementById('penaltyList');
            ul.innerHTML = '';

            if(list.length === 0) {
                ul.innerHTML='<li style="text-align:center;padding:20px;">ë‚´ì—­ ì—†ìŒ</li>';
                return;
            }

            list.forEach(i => {
                let b = i.Type==='ìƒì '?'bg-approved':'bg-rejected';
                ul.innerHTML+=`
                    <li class="history-item">
                        <div>
                            <strong>${i.Date}</strong><br>
                            <span style="color:#555;">${i.Reason}</span>
                        </div>
                        <span class="badge ${b}">${i.Points}ì </span>
                    </li>`;
            });
        } catch(e) {
            document.getElementById('penaltyList').innerHTML='<li style="text-align:center;padding:20px;">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</li>';
        }
    }

    // ë¯¼ì› ë‚´ì—­ ëª¨ë‹¬ ì—´ê¸°
    function openComplaintHistoryModal(type) {
        document.getElementById('complaintHistoryModal').style.display = 'flex';
        document.getElementById('complaintHistoryTitle').innerText = (type === 'REPAIR') ? 'ğŸ› ï¸ ìˆ˜ë¦¬ ìš”ì²­ ë‚´ì—­' : 'ğŸ“¨ ë¯¼ì› ì ‘ìˆ˜ ë‚´ì—­';
        loadComplaintHistory(type);
    }

    // â˜… ë¯¼ì› ë‚´ì—­ ë¡œë“œ (ê´€ë¦¬ì ì •ë³´ í¬í•¨)
    async function loadComplaintHistory(type) {
        try {
            const res = await fetch('/api/complaint/history');
            const list = await res.json();
            const ul = document.getElementById('complaintHistoryList');
            ul.innerHTML = '';

            const filteredList = list.filter(item => {
                const isRepair = item.Content.startsWith('[');
                return type === 'REPAIR' ? isRepair : !isRepair;
            });

            if(filteredList.length === 0) {
                ul.innerHTML = '<li style="text-align:center; color:#999; padding:20px;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            filteredList.forEach(item => {
                let b = 'bg-pending';
                if(item.Status === 'ì²˜ë¦¬ì¤‘') b = 'bg-process';
                if(item.Status === 'ì™„ë£Œ') b = 'bg-complete';

                // â˜… ê´€ë¦¬ì ì •ë³´ ì¶”ê°€
                let managerInfo = '';
                if (item.Manager_Name && item.Status !== 'ì ‘ìˆ˜') {
                    managerInfo = `<br><span style="font-size:12px; color:#999;">ì²˜ë¦¬ì: ${item.Manager_Name}</span>`;
                }

                ul.innerHTML += `
                    <li class="history-item">
                        <div>
                            <strong>${item.Date}</strong><br>
                            <span style="color:#555; font-size:14px;">${item.Content}</span>
                            ${managerInfo}
                        </div>
                        <span class="badge ${b}">${item.Status}</span>
                    </li>`;
            });
        } catch(e) {}
    }

    // ëª¨ë‹¬ ì—´ê¸°
    function openModal(id) {
        document.getElementById(id).style.display = 'flex';

        if(id === 'repairModal') {
            loadMyFacilities();
            document.getElementById('repairContent').value='';
        }
        if(id === 'absenceModal') {
            document.getElementById('startDate').value='';
            document.getElementById('returnDate').value='';
            document.getElementById('reason').value='';
        }
        if(id === 'pwdModal') {
            document.getElementById('currentPwd').value='';
            document.getElementById('newPwd').value='';
            document.getElementById('confirmPwd').value='';
        }
        if(id === 'complaintModal') {
            document.getElementById('complaintContent').value='';
        }
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
        if(confirm("ë¡œê·¸ì•„ì›ƒ?"))
            fetch('/api/logout',{method:'POST'}).then(()=>location.href='/login.html');
    }

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
    async function changePassword() {
        const c = document.getElementById('currentPwd').value;
        const n = document.getElementById('newPwd').value;
        const cf = document.getElementById('confirmPwd').value;

        if(!c || !n) return alert("ì…ë ¥ í•„ìš”");
        if(n !== cf) return alert("ë¹„ë²ˆ ë¶ˆì¼ì¹˜");

        const res = await fetch('/students/change-password', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({currentPassword:c, newPassword:n})
        });

        const r = await res.json();
        alert(r.message);
        if(r.success) closeModal('pwdModal');
    }
</script>
</body>
</html>